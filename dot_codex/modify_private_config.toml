#!/bin/sh
set -eu

input=$(cat || true)

printf '%s\n' "$input" | awk '
BEGIN {
  skip_managed_mcp_section = 0
}

/^[[:space:]]*\[[^]]+\][[:space:]]*$/ {
  if ($0 ~ /^[[:space:]]*\[mcp_servers\.(mgrep|context7)\][[:space:]]*$/) {
    skip_managed_mcp_section = 1
    next
  }

  skip_managed_mcp_section = 0
  print
  next
}

{
  if (!skip_managed_mcp_section) {
    print
  }
}

END {
  if (NR > 0) {
    print ""
  }

  print "# chezmoi-managed MCP servers"
  print "[mcp_servers.mgrep]"
  print "command = \"mgrep\""
  print "args = [\"mcp\"]"
  print ""
  print "[mcp_servers.context7]"
  print "command = \"npx\""
  print "args = [\"-y\", \"@upstash/context7-mcp\"]"
}
'
